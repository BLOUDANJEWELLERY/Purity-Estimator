<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gold Purity Estimator</title>
  <style>
    body {
      background-color: #1a1a1a;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background-color: #2c2c2c;
      padding: 20px;
      border-radius: 10px;
    }
    h1, h2 {
      text-align: center;
      color: #c7a332;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border: none;
      background-color: #3c3c3c;
      color: white;
    }
    button {
      background-color: #c7a332;
      cursor: pointer;
    }
    .section {
      margin-top: 30px;
    }
    .result-box {
      background-color: #444;
      padding: 15px;
      border-radius: 5px;
      margin-top: 10px;
    }
    .progress-bar {
      background-color: #222;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress {
      height: 20px;
      text-align: center;
      color: #000;
      font-weight: bold;
      line-height: 20px;
      transition: width 0.3s ease, background-color 0.3s ease;
    }
    .note {
      color: #c7a332;
      font-size: 0.9em;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gold Purity & Volume Estimator</h1>

    <div class="section">
      <h2>Option C: Weight-Based Water Displacement</h2>

      <!-- Gold Shape Selection -->
      <label for="shape">Select Gold Shape:</label>
      <select id="shape">
        <option value="rod">Rod/Cylinder</option>
        <option value="bar">Bar/Block</option>
        <option value="coin">Coin</option>
        <option value="nugget">Nugget/Irregular</option>
        <option value="other">Other</option>
      </select>

      <!-- Weight Inputs -->
      <input type="number" id="dryWeight" placeholder="Dry Weight of Gold (g)" step="any">
      <input type="number" id="displacedWater" placeholder="Displaced Water Weight (g)" step="any">

      <!-- Calibration Toggle -->
      <label><input type="checkbox" id="enableCalibration" onchange="toggleCalibration()"> Enable Calibration</label>

      <!-- Calibration Panel -->
      <div id="calibrationBox" style="display:none; margin-top:10px;">
        <input type="number" id="knownPurity" placeholder="Known Purity (e.g. 875)" step="any">
        <button onclick="calibrate()">Calibrate</button>
        <button onclick="resetCalibration()">Reset Calibration</button>
        <div id="calibrationStatus" class="note"></div>
      </div>

      <button onclick="calculatePurity()">Calculate Volume & Purity</button>

      <div id="displacementResult" class="result-box"></div>
      <div class="progress-bar">
        <div id="confidenceBar" class="progress" style="width: 0%">0%</div>
      </div>
    </div>
  </div>

  <script>
    let calibrationFactor = 1;
    let calibrationEnabled = false;

    // Load persisted calibration
    window.onload = function () {
      const storedFactor = localStorage.getItem("calibrationFactor");
      if (storedFactor) {
        calibrationFactor = parseFloat(storedFactor);
        calibrationEnabled = true;
        document.getElementById("enableCalibration").checked = true;
        toggleCalibration();
        document.getElementById("calibrationStatus").textContent = "Calibration loaded and active.";
      }
    };

    function toggleCalibration() {
      const box = document.getElementById("calibrationBox");
      calibrationEnabled = document.getElementById("enableCalibration").checked;
      box.style.display = calibrationEnabled ? 'block' : 'none';
    }

    function calibrate() {
      const dryWeight = parseFloat(document.getElementById("dryWeight").value);
      const displacedWater = parseFloat(document.getElementById("displacedWater").value);
      const knownPurity = parseFloat(document.getElementById("knownPurity").value);

      if (isNaN(dryWeight) || isNaN(displacedWater) || isNaN(knownPurity) || displacedWater === 0) {
        alert("Enter valid dry weight, displaced water, and known purity.");
        return;
      }

      const measuredDensity = dryWeight / displacedWater;
      const expectedDensity = (knownPurity / 1000) * 19.3;
      calibrationFactor = expectedDensity / measuredDensity;

      localStorage.setItem("calibrationFactor", calibrationFactor);
      document.getElementById("calibrationStatus").textContent = "Calibration successful. Factor applied to future results.";
    }

    function resetCalibration() {
      calibrationFactor = 1;
      localStorage.removeItem("calibrationFactor");
      document.getElementById("calibrationStatus").textContent = "Calibration reset. Default mode restored.";
    }

    function calculatePurity() {
      const dryWeight = parseFloat(document.getElementById("dryWeight").value);
      const displacedWater = parseFloat(document.getElementById("displacedWater").value);
      const shape = document.getElementById("shape").value;

      if (isNaN(dryWeight) || isNaN(displacedWater) || displacedWater === 0) {
        alert("Please enter valid dry weight and displaced water weight.");
        return;
      }

      const volume = displacedWater;
      const goldDensity = 19.3;
      let density = dryWeight / volume;

      // Apply calibration
      let calibrated = false;
      if (calibrationEnabled && localStorage.getItem("calibrationFactor")) {
        density *= calibrationFactor;
        calibrated = true;
      }

      const purityOutOf1000 = Math.min(1000, Math.max(0, Math.round((density / goldDensity) * 1000)));

      // Confidence Estimation
      let confidence = 100;

      if (dryWeight < 0.3) confidence -= 50;
      else if (dryWeight < 1) confidence -= 35;
      else if (dryWeight < 5) confidence -= 20;
      else if (dryWeight < 10) confidence -= 10;

      if (displacedWater < 0.3) confidence -= 30;
      else if (displacedWater < 1) confidence -= 20;
      else if (displacedWater < 3) confidence -= 10;

      if (shape === "nugget" || shape === "other") confidence -= 15;

      confidence = Math.max(0, Math.min(100, Math.round(confidence)));

      let color = "#ff0000";
      if (confidence > 85) color = "green";
      else if (confidence > 60) color = "orange";

      document.getElementById("displacementResult").innerHTML = `
        <b>Volume:</b> ${volume.toFixed(2)} cm³<br>
        <b>Density:</b> ${density.toFixed(3)} g/cm³<br>
        <b>Estimated Purity:</b> ${purityOutOf1000} / 1000<br>
        <div class="note">
          ${calibrated ? "**Calibrated result applied based on known sample.**<br>" : ""}
          Confidence reflects how likely this result is to be correct under current test conditions.
        </div>
      `;
      const bar = document.getElementById("confidenceBar");
      bar.style.width = confidence + "%";
      bar.style.backgroundColor = color;
      bar.textContent = confidence + "%";
    }
  </script>
</body>
</html>