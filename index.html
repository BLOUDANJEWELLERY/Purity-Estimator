<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gold Purity Estimator (Image + Auto-Detect)</title>
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <style>
    body { background-color: #111; color: white; font-family: sans-serif; padding: 20px; }
    canvas { border: 1px solid #444; max-width: 100%; margin-top: 10px; }
    input, button { margin: 10px 0; padding: 8px; width: 100%; background: #222; color: white; border: none; border-radius: 5px; }
    button { background-color: gold; color: black; cursor: pointer; }
    .result { background: #222; padding: 10px; margin-top: 15px; border-left: 4px solid gold; }
    .section { margin: 25px 0; }
    .tutorial { background: #222; padding: 15px; margin-top: 10px; border-left: 4px solid #4caf50; display: none; }
  </style>
</head>
<body>

<h1>Gold Purity Estimator (2-View + Auto-Scale)</h1>

<button onclick="document.getElementById('tutorial').style.display='block'">Show Step-by-Step Tutorial</button>

<div id="tutorial" class="tutorial">
  <h3>How to Use</h3>
  <ol>
    <li>Weigh your gold item and note its dry weight in grams.</li>
    <li>Take <b>two images</b> of the gold item:
      <ul>
        <li><b>Top View</b>: Include a round coin (like a 2.6 cm coin) next to the gold item.</li>
        <li><b>Side View</b>: Show the full vertical height.</li>
      </ul>
    </li>
    <li>Upload the top image. The tool will auto-detect the coin.</li>
    <li>Draw around the gold shape (top view).</li>
    <li>Upload side view and draw a vertical height line.</li>
    <li>Click "Estimate Purity".</li>
  </ol>
</div>

<div class="section">
  <label>Dry Weight (grams):</label>
  <input type="number" id="dryWeight" placeholder="e.g. 15.3">
</div>

<div class="section">
  <label>Upload Top View Image (with coin):</label>
  <input type="file" accept="image/*" onchange="loadTopImage(this)">
  <canvas id="topCanvas" width="400" height="400"></canvas>
</div>

<div class="section">
  <label>Upload Side View Image:</label>
  <input type="file" accept="image/*" onchange="loadSideImage(this)">
  <canvas id="sideCanvas" width="400" height="400"></canvas>
</div>

<button onclick="estimatePurity()">Estimate Purity</button>

<div id="result" class="result"></div>

<script>
  let topCanvas = document.getElementById("topCanvas");
  let sideCanvas = document.getElementById("sideCanvas");
  let topCtx = topCanvas.getContext("2d");
  let sideCtx = sideCanvas.getContext("2d");
  let topPoints = [], heightLine = [];
  let pxPerCm = null;

  // Load the top view image and detect the coin
  function loadTopImage(input) {
    const reader = new FileReader();
    reader.onload = function(e) {
      let img = new Image();
      img.onload = () => {
        topCanvas.width = img.width;
        topCanvas.height = img.height;
        topCtx.drawImage(img, 0, 0);
        detectCoinScale(img);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
    topCanvas.onclick = (e) => {
      const rect = topCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      topCtx.fillStyle = "red";
      topCtx.beginPath();
      topCtx.arc(x, y, 3, 0, Math.PI * 2);
      topCtx.fill();
      topPoints.push({ x, y });
    };
  }

  // Coin detection and scale calculation
  function detectCoinScale(img) {
    let mat = cv.imread(img);
    let gray = new cv.Mat();
    cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY); // Convert to grayscale
    let circles = new cv.Mat();

    // Adjust HoughCircle parameters: tune these values based on your image
    cv.HoughCircles(gray, circles, cv.HOUGH_GRADIENT, 1, 30, 100, 30, 10, 100);

    // Check if any circles were detected
    if (circles.cols > 0) {
      let circle = circles.data32F.slice(0, 3); // Get the first detected circle
      let centerX = circle[0];
      let centerY = circle[1];
      let radiusPx = circle[2];

      // Debug: log the detected circle's details
      console.log(`Coin detected! Center: (${centerX}, ${centerY}), Radius: ${radiusPx}px`);

      // Coin's known diameter (in cm)
      let coinDiameterCm = 2.6; // Updated to 2.6 cm

      // Calculate pixels per cm based on the detected radius
      pxPerCm = radiusPx * 2 / coinDiameterCm;

      // Draw the detected circle on the canvas (green outline)
      topCtx.strokeStyle = "lime"; // Green color for coin
      topCtx.lineWidth = 3; // Line width for the circle outline
      topCtx.beginPath();
      topCtx.arc(centerX, centerY, radiusPx, 0, 2 * Math.PI); // Draw circle
      topCtx.stroke();
    } else {
      // Alert if no coin is detected
      alert("Coin not detected. Please make sure it's visible and well-lit in the image.");
    }

    // Release OpenCV objects
    mat.delete();
    gray.delete();
    circles.delete();
  }

  // Load the side view image
  function loadSideImage(input) {
    const reader = new FileReader();
    reader.onload = function(e) {
      let img = new Image();
      img.onload = () => {
        sideCanvas.width = img.width;
        sideCanvas.height = img.height;
        sideCtx.drawImage(img, 0, 0);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);

    sideCanvas.onclick = (e) => {
      const rect = sideCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      sideCtx.fillStyle = "yellow";
      sideCtx.beginPath();
      sideCtx.arc(x, y, 3, 0, Math.PI * 2);
      sideCtx.fill();
      if (heightLine.length < 2) heightLine.push({ x, y });
    };
  }

  // Calculate the area of a polygon (for top view)
  function polygonArea(points) {
    let area = 0;
    for (let i = 0; i < points.length; i++) {
      let j = (i + 1) % points.length;
      area += points[i].x * points[j].y - points[j].x * points[i].y;
    }
    return Math.abs(area) / 2;
  }

  // Estimate the purity based on the images and weight
  function estimatePurity() {
    const weight = parseFloat(document.getElementById("dryWeight").value);
    const resultBox = document.getElementById("result");

    if (!weight || topPoints.length < 3 || heightLine.length < 2 || !pxPerCm) {
      alert("Please complete drawing and ensure coin was detected.");
      return;
    }

    const pixelDist = (a, b) => Math.hypot(a.x - b.x, a.y - b.y);
    const areaPx = polygonArea(topPoints);
    const areaCm2 = areaPx / (pxPerCm * pxPerCm);
    const heightCm = pixelDist(heightLine[0], heightLine[1]) / pxPerCm;

    const volume = areaCm2 * heightCm;
    const density = weight / volume;
    const purity = Math.round(Math.min(1000, (density / 19.3) * 1000));

    resultBox.innerHTML = `
      <b>Volume:</b> ${volume.toFixed(2)} cm³<br>
      <b>Density:</b> ${density.toFixed(2)} g/cm³<br>
      <b>Estimated Purity:</b> ${purity} / 1000
    `;
  }
</script>

</body>
</html>