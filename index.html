<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gold Purity Estimator (HoughCircles)</title>
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <style>
    body {
      background-color: #1a1a1a;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background-color: #2c2c2c;
      padding: 20px;
      border-radius: 10px;
    }
    h1, h2 {
      color: #c7a332;
      text-align: center;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      border: none;
      background-color: #3c3c3c;
      color: white;
    }
    button {
      background-color: #c7a332;
      cursor: pointer;
    }
    canvas {
      margin-top: 15px;
      max-width: 100%;
    }
    .result-box {
      background-color: #444;
      padding: 15px;
      border-radius: 5px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gold Purity Estimator (HoughCircles)</h1>

    <label>Upload Image (Top-Down with 100 Fils Coin):</label>
    <input type="file" accept="image/*" onchange="handleImage(event)">

    <label>Dry Weight of Gold (g):</label>
    <input type="number" id="dryWeight" step="any">

    <label>Gold Shape:</label>
    <select id="shape">
      <option value="rod">Rod/Cylinder</option>
      <option value="bar">Bar/Block</option>
      <option value="coin">Coin</option>
      <option value="irregular">Irregular/Nugget</option>
    </select>

    <button onclick="calculateFromImage()">Estimate Purity</button>
    <button onclick="reset()">Retake Photo</button>

    <canvas id="canvas"></canvas>
    <div class="result-box" id="resultBox"></div>
  </div>

  <script>
    let imgElement = null;

    function handleImage(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        imgElement = new Image();
        imgElement.onload = function() {
          const canvas = document.getElementById("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = imgElement.width;
          canvas.height = imgElement.height;
          ctx.drawImage(imgElement, 0, 0);
        };
        imgElement.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function reset() {
      document.getElementById("canvas").getContext("2d").clearRect(0, 0, 10000, 10000);
      document.getElementById("resultBox").innerHTML = "";
      document.querySelector("input[type='file']").value = "";
    }

    async function calculateFromImage() {
      const dryWeight = parseFloat(document.getElementById("dryWeight").value);
      if (isNaN(dryWeight)) {
        alert("Enter dry weight.");
        return;
      }

      const canvas = document.getElementById("canvas");
      if (!canvas.width) {
        alert("Please upload an image.");
        return;
      }

      if (!cv || !cv.imread) {
        alert("OpenCV.js not yet loaded.");
        return;
      }

      let src = cv.imread(canvas);
      let gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(gray, gray, new cv.Size(9, 9), 2, 2);

      // Detect circle (100 fils coin)
      let circles = new cv.Mat();
      cv.HoughCircles(gray, circles, cv.HOUGH_GRADIENT, 1, 50, 100, 30, 10, 200);

      if (circles.cols < 1) {
        document.getElementById("resultBox").innerHTML = "Reference coin not detected.";
        src.delete(); gray.delete(); circles.delete();
        return;
      }

      // Use first detected circle
      let x = circles.data32F[0];
      let y = circles.data32F[1];
      let radiusPx = circles.data32F[2];
      const coinDiameterPx = radiusPx * 2;

      // Scale detection
      const coinDiameterMm = 26.0;
      const pixelToMm = coinDiameterMm / coinDiameterPx;

      // Segment other object (gold) using threshold
      let binary = new cv.Mat();
      cv.threshold(gray, binary, 50, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

      // Find contours for gold
      let contours = new cv.MatVector();
      let hierarchy = new cv.Mat();
      cv.findContours(binary, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      let maxArea = 0;
      for (let i = 0; i < contours.size(); i++) {
        let cnt = contours.get(i);
        let area = cv.contourArea(cnt);
        if (area > maxArea) maxArea = area;
        cnt.delete();
      }

      if (maxArea === 0) {
        document.getElementById("resultBox").innerHTML = "Gold object not detected.";
        src.delete(); gray.delete(); circles.delete(); binary.delete(); contours.delete(); hierarchy.delete();
        return;
      }

      const goldAreaMm2 = maxArea * (pixelToMm ** 2);
      const shape = document.getElementById("shape").value;

      let heightMm = 1.5;
      if (shape === "rod") heightMm = 15;
      else if (shape === "bar") heightMm = 10;
      else if (shape === "coin") heightMm = 1.5;
      else if (shape === "irregular") heightMm = 8;

      const volumeCm3 = (goldAreaMm2 * heightMm) / 1000; // mm³ to cm³
      const density = dryWeight / volumeCm3;
      const goldDensity = 19.3;
      const purity = Math.round((density / goldDensity) * 1000);

      document.getElementById("resultBox").innerHTML = `
        <b>Detected Coin Radius:</b> ${radiusPx.toFixed(2)} px<br>
        <b>Scale:</b> ${pixelToMm.toFixed(4)} mm/px<br>
        <b>Gold Area:</b> ${goldAreaMm2.toFixed(2)} mm²<br>
        <b>Assumed Height:</b> ${heightMm} mm<br>
        <b>Volume:</b> ${volumeCm3.toFixed(2)} cm³<br>
        <b>Density:</b> ${density.toFixed(2)} g/cm³<br>
        <b>Estimated Purity:</b> ${Math.min(purity, 1000)} / 1000
      `;

      src.delete(); gray.delete(); circles.delete(); binary.delete(); contours.delete(); hierarchy.delete();
    }
  </script>
</body>
</html>