<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gold Purity Estimator with AR</title>
  <style>
    body {
      background-color: #1a1a1a;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background-color: #2c2c2c;
      padding: 20px;
      border-radius: 10px;
    }
    h1, h2 {
      text-align: center;
      color: #c7a332;
    }
    button {
      padding: 10px;
      width: 100%;
      margin: 10px 0;
      border-radius: 5px;
      background-color: #c7a332;
      color: white;
      cursor: pointer;
    }
    #arContainer {
      width: 100%;
      height: 400px;
      background-color: #333;
      margin-top: 20px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gold Purity & Volume Estimator</h1>

    <!-- Option A: WebXR 3D Scanning with 3D Model Placement -->
    <div class="section">
      <h2>Option A: Advanced 3D Scanning (AR)</h2>
      <button onclick="startARSession()">Start AR Scan</button>
      <div id="arContainer"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    let xrSession = null;
    let gl = null;
    let renderer = null;
    let scene = null;
    let camera = null;
    let hitTestSource = null;
    let hitTestSourceInitialized = false;
    let model = null;

    // Check if WebXR is supported
    async function checkWebXRSupport() {
      if (!navigator.xr) {
        alert("WebXR is not supported on this browser.");
        return false;
      }

      const isSupported = await navigator.xr.isSessionSupported("immersive-ar");
      if (isSupported) {
        alert("WebXR AR is supported on this device.");
        return true;
      } else {
        alert("WebXR AR is not supported on this device.");
        return false;
      }
    }

    // Start AR session and 3D rendering
    async function startARSession() {
      const supported = await checkWebXRSupport();
      if (!supported) return;

      // Start WebXR AR session
      xrSession = await navigator.xr.requestSession("immersive-ar", {
        requiredFeatures: ["hit-test", "anchor"]
      });

      gl = document.createElement("canvas").getContext("webgl", { xrCompatible: true });
      renderer = new THREE.WebGLRenderer({ canvas: gl.canvas });
      renderer.xr.enabled = true;
      document.getElementById("arContainer").appendChild(gl.canvas);

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 0, 0);
      
      const loader = new THREE.GLTFLoader();
      loader.load('your-3d-model.glb', (gltf) => {
        model = gltf.scene;
        model.scale.set(0.1, 0.1, 0.1); // Scale the model as needed
        scene.add(model);
      });

      xrSession.updateRenderState({ baseLayer: new XRWebGLLayer(xrSession, gl) });
      const referenceSpace = await xrSession.requestReferenceSpace("viewer");
      xrSession.requestAnimationFrame(onXRFrame);

      // Hit-test setup
      if (!hitTestSourceInitialized) {
        xrSession.requestHitTestSource({ space: referenceSpace }).then((source) => {
          hitTestSource = source;
          hitTestSourceInitialized = true;
        });
      }
    }

    // Animation loop for XR frame
    async function onXRFrame(time, xrFrame) {
      const xrSession = xrFrame.session;
      const referenceSpace = await xrSession.requestReferenceSpace("viewer");

      const hitTestResults = xrFrame.getHitTestResults(hitTestSource);

      if (hitTestResults.length > 0) {
        const hitPose = hitTestResults[0].getPose(referenceSpace);
        if (model) {
          model.position.set(hitPose.transform.position.x, hitPose.transform.position.y, hitPose.transform.position.z);
        }
      }

      renderer.render(scene, camera);
      xrSession.requestAnimationFrame(onXRFrame);
    }
  </script>
</body>
</html>